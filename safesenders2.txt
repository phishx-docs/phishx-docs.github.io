# POWERSHELL 7 - ADMINISTRATOR
# https://learn.microsoft.com/en-us/powershell/module/exchangepowershell/set-mailboxjunkemailconfiguration?view=exchange-ps
#
# HOW TO RUN THIS .TXT FILE AS POWERSHELL SCRIPT:
# Method 1: Get-Content .\safesenders2.txt -Raw | Invoke-Expression
# Method 2: $AdminUser = "admin@domain.com"; $TestUser = "test@domain.com"; Get-Content .\safesenders2.txt -Raw | Invoke-Expression
# Method 3: powershell.exe -Command "& {$(Get-Content .\safesenders2.txt -Raw)}"
# Method 4: powershell.exe -ExecutionPolicy Bypass -File .\safesenders2.txt
#
# IF YOU GET "not digitally signed" ERROR:
# Solution 1: Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
# Solution 2: powershell.exe -ExecutionPolicy Bypass -File .\safesenders2.txt
# Solution 3: Use Method 1 above (Get-Content + Invoke-Expression)
#
# Notes:
# You can't add sender email addresses from the same domain as the recipient's email address. All mailboxes in the global address list (GAL) are automatically considered as trusted senders.
# You can't add the same email address or domain more than once.

clear

# VARIABLES
$userAdmin = if ($AdminUser) { $AdminUser } else { "USER-ADMIN@DOMAIN" }
$userTest = if ($TestUser) { $TestUser } else { "USER-TEST@DOMAIN" }
$userDomain = ($userTest.Split('@'))[1]
$errorLogFile = ".\JunkEmailConfigErrors.txt"

# MODULES
# Check if ExchangeOnlineManagement module is installed and up-to-date
$moduleName = "ExchangeOnlineManagement"
$installedModule = Get-Module -ListAvailable -Name $moduleName | Sort-Object Version -Descending | Select-Object -First 1
$onlineModule = Find-Module -Name $moduleName -ErrorAction SilentlyContinue

if (-not $installedModule) {
  Write-Host "Installing $moduleName module..." -ForegroundColor Yellow
  Install-Module -Name $moduleName -Scope CurrentUser -Force -AllowClobber -AcceptLicense
} elseif ($onlineModule -and ($installedModule.Version -lt $onlineModule.Version)) {
  Write-Host "Updating $moduleName module from version $($installedModule.Version) to $($onlineModule.Version)..." -ForegroundColor Yellow
  Update-Module -Name $moduleName -Force
} else {
  Write-Host "$moduleName module is already installed and up-to-date (version $($installedModule.Version))" -ForegroundColor Green
}

Connect-ExchangeOnline -UserPrincipalName $userAdmin
# (Get-ConnectionInformation).UserPrincipalName

# CONTACTS
$All = Get-Mailbox -RecipientTypeDetails UserMailbox -ResultSize Unlimited
$AllQty = $All | Measure-Object | Select-Object -ExpandProperty Count
$AllQtyDigits = $AllQty.ToString().Length
Write-Host "Users: ${AllQty}"

# DOMAINS
$safeDomains = @("appcentral.info","appstudio.shop","businessuniversity.tech","cloudacademy.live","cloudconnect.cfd","dealsnews.club","deviceguard.pro","digitaleducation.digital","festivalnews.online","infoportal.live","linkdata.live","mailvault.site","marketonline.one","microlearning.academy","peoplex.io","phishing.com.br","phishx.com","phishx.com.br","phishx.io","privacynow.click","proopportunity.one","securedevice.site","securetech.lat","securityapp.cloud","smartdevice.live","technews.rest","trainingportal.me","varejoonline.club","webportal.one")
$safeDomainsQty = $safeDomains | Measure-Object | Select-Object -ExpandProperty Count
Write-Host "Domains: ${safeDomainsQty}"

# PROCESS - OPTIMIZED BATCH PROCESSING
Clear-Content -Path $errorLogFile -ErrorAction SilentlyContinue
$startTime = Get-Date
Write-Host "Starting optimized processing..." -ForegroundColor Cyan

$totalProcessed = 0
$totalErrors = 0
$errorMessages = @()

# Process mailboxes with progress tracking and batching
foreach ($mailbox in $All) {
    $totalProcessed++
    $indexPadded = $totalProcessed.ToString().PadLeft($AllQtyDigits, '0')
    $mailboxName = $mailbox.Name
    $mailboxAlias = $mailbox.Alias

    # Optimize email domain extraction
    $userDomains = $mailbox.EmailAddresses |
        Where-Object { $_ -notlike "*SPO_*" } |
        ForEach-Object { ($_.ToString() -split '[@:]')[-1] } |
        Sort-Object -Unique

    # Use -notin for faster lookups
    $filteredSafeDomains = $safeDomains | Where-Object { $_ -notin $userDomains }
    $filteredSafeDomainsQty = $filteredSafeDomains.Count

    try {
        # Only proceed if there are domains to add
        if ($filteredSafeDomains.Count -gt 0) {
            Set-MailboxJunkEmailConfiguration $mailboxName -TrustedSendersAndDomains @{Add=$filteredSafeDomains} -ErrorAction Stop
            Write-Host "${indexPadded} / ${AllQty}: ✓ Updated ${filteredSafeDomainsQty} domains for ${mailboxAlias}" -ForegroundColor Green
        } else {
            Write-Host "${indexPadded} / ${AllQty}: ⚠ No new domains to add for ${mailboxAlias}" -ForegroundColor Yellow
        }
    }
    catch {
        $totalErrors++
        $errorMessage = "${indexPadded} / ${AllQty}: ✗ Error processing $mailboxAlias (Domains: $($userDomains -join ',')): $($_.Exception.Message)"
        Write-Host $errorMessage -ForegroundColor Red
        $errorMessages += $errorMessage
    }

    # Progress indicator every 10 items
    if ($totalProcessed % 10 -eq 0) {
        $elapsed = (Get-Date) - $startTime
        $avgPerItem = $elapsed.TotalSeconds / $totalProcessed
        $estimatedTotal = $avgPerItem * $AllQty
        $remaining = $estimatedTotal - $elapsed.TotalSeconds
        Write-Host "Progress: $totalProcessed/$AllQty ($(($totalProcessed/$AllQty*100).ToString('F1'))%) | ETA: $([TimeSpan]::FromSeconds($remaining).ToString('mm\:ss'))" -ForegroundColor Cyan
    }
}

# Write errors to file
if ($errorMessages.Count -gt 0) {
    $errorMessages | Out-File -FilePath $errorLogFile -Encoding UTF8
}

$endTime = Get-Date
$duration = $endTime - $startTime
Write-Host "Script finished in $($duration.TotalSeconds.ToString('F2')) seconds. Processed: ${totalProcessed}, Errors: ${totalErrors}" -ForegroundColor Cyan

# SINGLE TEST - Display current configuration
$output = @{
  email = $userTest
  userDomain = $userDomain
  trustedSendersAndDomains = (Get-MailboxJunkEmailConfiguration -Identity $userTest).TrustedSendersAndDomains
}
$output | ConvertTo-Json -Depth 3

#### VALIDAÇÃO MANUAL
# OUTLOOK NOVO
#
# Configurações -> E-mail -> Lixo eletrônico
# Remetentes -> Domínios e remetentes
#
# OUTLOOK ANTIGO
#
# Página Inicial -> Excluir -> Bloquear -> Opções de Lixo Eletrônico
# Remetentes Confiáveis
#### 20251009
